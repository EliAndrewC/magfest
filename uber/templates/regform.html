{% import 'macros.html' as macros with context %}

{#- Setting some variables to keep the size of conditional clauses smaller. -#}
{%- set is_prereg_form = c.PAGE_PATH in ['/preregistration/form', '/preregistration/post_form'] -%}
{%- set is_prereg_dealer = c.PAGE_PATH in ['/preregistration/dealer_registration', 'preregistration/post_dealer'] or attendee and attendee.badge_type == c.PSEUDO_DEALER_BADGE -%}
{%- set is_prereg_confirm_email_enabled = (is_prereg_form or is_prereg_dealer) and c.PREREG_CONFIRM_EMAIL_ENABLED -%}
{%- set is_after_request_hotel = c.AFTER_PREREG_REQUEST_HOTEL_INFO_DEADLINE -%}
{%- set is_after_hotel_email = c.AFTER_PREREG_HOTEL_INFO_EMAIL_DATE -%}

{% set prereg_intro %}
    <div id="bold-field-message" class="form-group">
        <div class="col-sm-offset-3 col-sm-9 heading-label">Bold fields are required</div>
    </div>
{% endset %}


{% set badge_buttons %}
<script type="text/javascript">
        {#
          Make the PREREG_BADGE_TYPES array available in javascript. Also
          converts the integer values to strings, because that is what we'll
          be comparing them to.
        #}
        var PREREG_BADGE_TYPES = [
            {% for i in c.PREREG_BADGE_TYPES %}'{{ i }}'{% if not loop.last %}, {% endif %}{% endfor %}
        ];
        var PREREG_CHECK_INTERVAL = 15 * 60 * 1000;
        var checkCap = function () {
            $.getJSON('../preregistration/check_prereg', function (check) {
                if (check.force_refresh) {
                    location.reload();  // Reload the page to prevent registering after reg is closed
                } else {
                    setTimeout(checkCap, PREREG_CHECK_INTERVAL);
                }
            });
        };
        setTimeout(checkCap, PREREG_CHECK_INTERVAL);

        var updateBadgeTypeHiddenInput = function(newBadgeType) {
            if ($.inArray($('input[name="badge_type"]').val(), PREREG_BADGE_TYPES) > -1) {
                $('input[name="badge_type"]').val(newBadgeType);
            }
        };

        var REG_TYPES = {
            row: '#reg-types',
            selector: '.reg-type-selector',
            options: [{
                title: 'Single Attendee',
                description: 'A single registration; you can register more before paying.',
                onClick: function () {
                    $('.group_fields').addClass('hide');
                    $('.non_group_fields').removeClass('hide');
                    updateBadgeTypeHiddenInput('{{ c.ATTENDEE_BADGE }}');
                    if ($.field('first_name')) {
                        $('#bold-field-message').insertBefore($.field('first_name').parents('.form-group'));
                    }
                    showOrHideBadgeTypes();
                    togglePrices();
                }
            }]
        };
        {% if c.GROUPS_ENABLED and attendee and attendee.is_new and not group_id %}
            REG_TYPES.options.push({
                title: 'Group Leader',
                {% if c.BEFORE_GROUP_PREREG_TAKEDOWN %}
                    description: '<p class="list-group-item-text">Register a group of {{ c.MIN_GROUP_SIZE }} people or more. (Please purchase badges for children 12 and under separate from your group.)</p>',
                {% else %}
                    description: '<p class="list-group-item-text">The deadline for Group registration has passed, but you can still register as a regular attendee.</p>',
                {% endif %}
                onClick: function () {
                    {% if c.BEFORE_GROUP_PREREG_TAKEDOWN %}
                        $('.group_fields').removeClass('hide');
                        $('.non_group_fields').addClass('hide');
                        updateBadgeTypeHiddenInput('{{ c.PSEUDO_GROUP_BADGE }}');
                        $('#bold-field-message').insertBefore($.field('name').parents('.form-group'));
                        showOrHideBadgeTypes();
                        togglePrices();
                    {% else %}
                        setBadge(REG_TYPES, 0);
                        toastr.clear();
                        toastr.error('Group registration has closed.');
                    {% endif %}
                }
            });
        {% endif %}
        var BADGE_TYPES = {
            row: '#badge-types',
            selector: '.badge-type-selector',
            options: [],
        };
        {% if not attendee or attendee.is_new or attendee.badge_type not in c.BADGE_TYPE_PRICES %}
        BADGE_TYPES.options.push({
                title: '{% if c.PAGE_PATH in ["/preregistration/form", "/preregistration/post_form", "/preregistration/dealer_registration", "/preregistration/post_dealer"] or undoing_extra %}Attending{% elif attendee %}{{ attendee.ribbon_and_or_badge }}{% endif %}',
                description: 'Allows access to the convention for its duration.',
                extra: 0,
                badge_type: '{{ c.ATTENDEE_BADGE }}',

                price: {{ badge_cost if badge_cost is defined else c.BADGE_PRICE }},
                onClick: function () {
                    $('input[name="badge_type"]').val('{{ c.ATTENDEE_BADGE }}');
                }
        });
        {% endif %}
        {% if c.SHIRT_LEVEL in c.PREREG_DONATION_TIERS and c.SHIRT_AVAILABLE %}
            BADGE_TYPES.options.push({
                title: 'Add a tshirt',
                description: 'Add a {{ c.EVENT_NAME }} themed t-shirt to your registration.',
                extra: {{ c.SHIRT_LEVEL }},
                price: {{ c.BADGE_PRICE }}
            });
        {% endif %}
        {% if c.SUPPORTER_LEVEL in c.PREREG_DONATION_TIERS and c.SUPPORTER_AVAILABLE %}
            BADGE_TYPES.options.push({
                title: 'Supporter',
                description: 'Donate extra and get more swag with your registration.',
                extra: {{ c.SUPPORTER_LEVEL }},
                price: {{ c.BADGE_PRICE }}
            });
        {% endif %}
        {% if c.SEASON_LEVEL in c.PREREG_DONATION_TIERS and c.SEASON_AVAILABLE %}
            BADGE_TYPES.options.push({
                title: 'Super Supporter',
                description: 'Donate even more and get exclusive swag!',
                extra: {{ c.SEASON_LEVEL }},
                price: {{ c.BADGE_PRICE }}
            });
        {% endif %}

        {% for badge_type in c.BADGE_TYPE_PRICES %}

            {% if badge_type != c.ATTENDEE_BADGE %}
        {% if (badge_type != c.SPONSOR_BADGE or c.SPONSOR_BADGE_AVAILABLE) and (badge_type != c.SHINY_BADGE or c.SHINY_BADGE_AVAILABLE) %}
            BADGE_TYPES.options.push({
                title: '{{ c.BADGES[badge_type] }}',
                description: 'Donate extra to get an upgraded badge with perks.',
                extra: 0,
                price: {{ c.BADGE_TYPE_PRICES[badge_type] }},
                badge_type: '{{ badge_type }}',
                onClick: function () {
                    $('input[name="badge_type"]').val('{{ badge_type }}');
                }
            });
        {% endif %}
            {% endif %}
        {% endfor %}

        BADGE_TYPES.options.sort(function(a, b){
            return (a.price > b.price) ? 1 : (a.price < b.price) ? -1 : 0;
        });

        var togglePrices = function () {
            var showTotalPrices = {% if c.PAGE_PATH in ['/preregistration/form', '/preregistration/post_form'] and not c.PREREG_DONATION_DESCRIPTIONS %}($.val('badge_type') != {{ c.PSEUDO_DEALER_BADGE }}){% else %}false{% endif %};
            $.each(BADGE_TYPES.options, function (i, type) {
                var $price = $(BADGE_TYPES.selector).slice(i, i + 1).find('.price').empty();
                var $price_notice = $(BADGE_TYPES.selector).slice(i, i + 1).find('.price_notice').empty();
                if (showTotalPrices) {
                    $price.append(': $').append(type.extra + type.price);
                    {% for amount_extra, val in c.PREREG_DONATION_OPTS %}
                        if (type.extra == {{ amount_extra }} && type.extra >= {{ c.SEASON_LEVEL }}) {
                            $price_notice.append('{{ price_notice("Super Supporter registration", c.SUPPORTER_DEADLINE, c.SEASON_LEVEL) }}')
                        } else if (type.extra == {{ amount_extra }} && type.extra >= {{ c.SUPPORTER_LEVEL }}) {
                            $price_notice.append('{{ price_notice("Supporter registration", c.SUPPORTER_DEADLINE, c.SUPPORTER_LEVEL) }}')
                        } else if (type.extra == {{ amount_extra }} && type.extra >= {{ c.SHIRT_LEVEL }}) {
                            $price_notice.append('{{ price_notice("T-Shirt registration", c.SHIRT_DEADLINE, c.SHIRT_LEVEL) }}')
                        } else if (type.extra == {{ amount_extra }} && !type.badge_type ) {
                            $price_notice.append('{{ price_notice("Preregistration", c.PREREG_TAKEDOWN, amount_extra) }}')
                        }
                    {% endfor %}
                } else if (type.extra) {
                    $price.append(': +$').append(type.extra);
                } else if (type.price) {
                    $price.append(': $').append(type.price);
                }
            });
            $.each(REG_TYPES.options, function (i, type) {
                var $price = $(REG_TYPES.selector).slice(i, i + 1).find('.price').empty();
                var $price_notice = $(REG_TYPES.selector).slice(i, i + 1).find('.price_notice').empty();
                if (!showTotalPrices) {
                    if (type.title == 'Single Attendee') {
                        $price.append(': $').append({{ c.BADGE_PRICE }});
                        $price_notice.append('{{ price_notice("Preregistration", c.PREREG_TAKEDOWN) }}')
                    } else if (type.title == 'Group Leader') {
                        $price.append(': $').append({{ c.GROUP_PRICE }}).append(' per badge');
                        $price_notice.append('{{ price_notice("Group registration", c.GROUP_PREREG_TAKEDOWN, 0, c.GROUP_DISCOUNT) }}')
                    }
                }
            });
        };
        var showOrHideBadgeTypes = function () {
            // We use 'pseudo' badge types to create dealers and groups, which is antithetical to using attending-facing
            // badge types for upgrades. We thus want to hide any badge buttons with a unique badge type if the attendee
            // is a dealer or group leader.
            if ($(BADGE_TYPES.row).size()) {
                $.each(BADGE_TYPES.options, function (i, badgeType) {
                    if (badgeType.badge_type && badgeType.badge_type != {{ c.ATTENDEE_BADGE }}) {
                        var current_button = $(BADGE_TYPES.selector).slice(i, 1+i);
                        current_button.toggle($.field('badge_type').val() != '{{ c.PSEUDO_GROUP_BADGE }}' && $.field('badge_type').val() != '{{ c.PSEUDO_DEALER_BADGE }}');
                        // If an 'invalid' badge type is currently selected when the reg type is changed, reset to the
                        // first in the list
                        if (!current_button.is(":visible") && current_button.hasClass('active')) {
                            setBadge(BADGE_TYPES, 0);
                        }
                    }
                });
            }
        };
        var setBadge = function (types, index) {
            var type = types.options[index];
            $(types.selector)
                .removeClass('active')
                .slice(index, 1 + index)
                .addClass('active');
            (type.onClick || $.noop)();
        };
        var setKickinFromBadge = function (types, index) {
            var type = types.options[index];
            if (type.extra !== undefined && type.extra !== null && $.field('amount_extra')) {
                {% if c.PREREG_DONATION_DESCRIPTIONS %}
                    $('input:radio[name=amount_extra][value='+ type.extra +']').prop('checked', true).trigger('change');
                {% else %}
                    $.field('amount_extra').val(type.extra).trigger('change');
                {% endif %}
            }
        };
        var makeBadgeMatchExtra = function () {
            if (_(BADGE_TYPES.options).size()) {
                var target = 0;
                $.each(BADGE_TYPES.options, function (i, badgeType) {
                    if (badgeType.extra && $.field('amount_extra') && badgeType.extra == $.val('amount_extra')) {
                        target = i;
                    } else if (badgeType.badge_type && badgeType.badge_type == $.val('badge_type')) {
                        target = i;
                    }
                });
                if (!$(BADGE_TYPES.selector).slice(target, 1 + target).is('.active')) {
                    setBadge(BADGE_TYPES, target);
                }
            }
        };
        $(function () {
            showOrHideBadgeTypes();
            if ($(BADGE_TYPES.row).size()) {
                $.each([REG_TYPES, BADGE_TYPES], function (i, types) {
                  var $row = $('<div class="row"></div>');
                    $(types.row).append($('<div class="col-sm-9"></div>').append($row));
                    $.each(types.options, function (index, type) {
                        $row.append(
                            $('<div class="col-btn col-sm-4"></div>').append(
                                $('<a class="list-group-item"></a>').addClass(types.selector.substring(1)).click(function () {
                                    setBadge(types, index);
                                    setKickinFromBadge(types, index);
                                }).append(
                                    $('<h4 class="list-group-item-heading"></h4>')
                                        .append(type.title)
                                        .append('<span class="price"></span>')
                                ).append(
                                    $('<p class="list-group-item-text"></p>').html(type.description).append('<span class="price_notice"></span>'))));
                    });
                    $row.append('<div class="clearfix"></div>');
                });
                {% if attendee and attendee.badge_type in [c.ATTENDEE_BADGE, c.PSEUDO_GROUP_BADGE, c.PSEUDO_DEALER_BADGE] %}
                if (window.REG_TYPES && $(REG_TYPES.row).size() ) {
                    setBadge(REG_TYPES, $.field('name') && $.val('name') ? 1 : 0);  // default to attendee or group
                }
                {% endif %}
                makeBadgeMatchExtra();
                if ($.field('amount_extra')) {
                    {% if not c.PREREG_DONATION_DESCRIPTIONS %}
                        $.field('amount_extra').parents('.form-group').hide();
                    {% else %}
                        $.field('amount_extra').on('change', makeBadgeMatchExtra);
                    {% endif %}
                }
            }
            togglePrices();
        });
    </script>
{% if not attendee.is_new %}
  <div class="form-group" id="badge-types">
    <label class="col-sm-3 control-label">Badge Level</label>
  </div>
{% endif %}
{% endset %}


{% set badge_type %}
{% if admin_area %}
<div class="form-group">
    <label class="col-sm-3 control-label">Badge</label>
    <div class="col-sm-6">
        {% if not attendee.is_new %}
            {{ attendee.badge }}
            {% if attendee.group %}(<a href="../groups/form?id={{ attendee.group.id }}">{{ attendee.group.name }}</a>){% endif %}
            &nbsp;&nbsp; [<a href="change_badge?id={{ attendee.id }}">Change</a>]
        {% else %}
            <select name="badge_type" onChange="boldOrRegular(); setBadgeMessage(); setAmountPaid();">
                {{ options(c.BADGE_OPTS,attendee.badge_type) }}
            </select>
            {% if c.AT_THE_CON and c.NUMBERED_BADGES %}
                #<input class="focus" type="text" style="width:4em" name="badge_num" value="{{ attendee.badge_num|default('', boolean=True) }}" />
            {% else %}
                <span id="badge_message" style="font-style:italic"></span>
            {% endif %}
        {% endif %}
        &nbsp;&nbsp;
        {% if c.AT_THE_CON and not attendee.badge_num and c.NUMBERED_BADGES %}
            <br/> <input type="checkbox" name="omit_badge" value="yes" {% if omit_badge %}checked{% endif %} /> Omit badge number
        {% elif c.AT_THE_CON and not attendee.checked_in and not c.NUMBERED_BADGES %}
            <br/> <input type="checkbox" name="check_in" value="yes" {% if check_in %}checked{% endif %} /> Check in this attendee
        {% endif %}
        &nbsp;&nbsp; [<a href="../preregistration/confirm?id={{ attendee.id }}">Confirm{% if attendee.is_transferable %}/Transfer{% endif %}</a>]
    </div>
</div>
{% else %}
<script type="text/javascript">
  {% if not attendee.is_new and not attendee.amount_unpaid %}
      // This removes any badge levels lower than the attendee has purchased already
      if (window.BADGE_TYPES) {
          while (_(BADGE_TYPES.options).size() && BADGE_TYPES.options[0].extra < {{ attendee.amount_extra }}) {
              BADGE_TYPES.options.splice(0, 1);
          }
          while (_(BADGE_TYPES.options).size() && BADGE_TYPES.options[0].price && BADGE_TYPES.options[0].price < {{ attendee.base_badge_price|default(c.BADGE_TYPE_PRICES[attendee.badge_type]|default(c.BADGE_PRICE, boolean=True)) }}) {
              BADGE_TYPES.options.splice(0, 1);
          }
      }

      // This is the same idea, except it disables the kick-in buttons and then hides them
      $(function () {
          if($('input:radio[name=amount_extra]').size()) {
              $('input:radio[name=amount_extra]').each( function() {
                  if (!isNaN($(this).val()) && Number($(this).val()) < {{ attendee.amount_extra }}) {
                      $(this).prop('disabled', true);
                      $(this).parent().hide();
                  }
              });
          }
      });
  {% endif %}
</script>
<div class="form-group">
        <label for="badge_type" class="col-sm-3 control-label">Badge Type</label>
        <div class="col-sm-6 form-control-static">{{ attendee.badge_type_label }}</div>
    </div>
{% if '/registration/' not in c.PAGE_PATH or not attendee.is_new %}
    <input type="hidden" name="badge_type" value="{{ attendee.badge_type }}" />
{% endif %}
{% endif %}
{% endset %}


{% set name %}
{% set read_only = name_ro or page_ro %}
{% if not admin_area %}
<script type="text/javascript">
  var sameLegalNameChecked = function () {
        if ($("#same_legal_name").prop('checked')) {
            $.field('legal_name').prop('readonly', true).val('').prop('required', false).valid();
            $("label[for='legal_name']").addClass('optional-field');
        } else if ($("#same_legal_name").length) {
            $.field('legal_name').prop('readonly', false).prop('required', true);
            $("label[for='legal_name']").removeClass('optional-field');
        }
    };
    $(function () {
        if ($('#same_legal_name').length) {
            sameLegalNameChecked();
            $('#same_legal_name').change(sameLegalNameChecked);
        }
    })
</script>
{% endif %}
    <div class="form-group">
        <label for="first_name" class="col-sm-3 control-label">Name</label>
      {% call macros.read_only_if(read_only, attendee.full_name) %}
        <div class="col-sm-3">
            <input type="text" name="first_name" id="first_name" value="{{ attendee.first_name }}" class="form-control" placeholder="First Name" autocomplete="fname">
        </div>
        <div class="col-sm-3">
            <input type="text" name="last_name" id="last_name" value="{{ attendee.last_name }}" class="form-control" placeholder="Last Name" autocomplete="lname">
        </div>
      {% endcall %}
    </div>

{% if not admin_area and not read_only %}
    <div class="form-group">
        <div class="col-sm-9 col-sm-offset-3">
          <label for="same_legal_name" class="checkbox-label">
            <input type="checkbox" name="same_legal_name" id="same_legal_name" value="1" {% if attendee.first_name != '' and attendee.legal_name == '' %}checked="checked"{% endif %} />
            The above name is exactly what appears on my Legal Photo ID
          </label>
        </div>
    </div>
{% endif %}

    <div class="form-group">
        <label for="legal_name" class="col-sm-3 control-label">Name as appears on <span class="text-nowrap">Legal Photo ID</span></label>
      {% call macros.read_only_if(read_only, attendee.legal_name) %}
        <div class="col-sm-6">
            <input type="text" name="legal_name" value="{{ attendee.legal_name }}" class="form-control" placeholder="Name exactly as it appears on Photo ID" autocomplete="name" />
            <p class="help-block">
              <span class="popup">{{ macros.popup_link("../static_views/legal_name.html", 'What does "Legal Photo ID" mean?') }}</span>
            </p>
        </div>
      {% endcall %}
    </div>
{% endset %}


{% set amount_extra %}
{% if c.DONATIONS_ENABLED and c.PAGE_PATH != '/registration/form' %}
    {% if c.PREREG_DONATION_OPTS and c.PREREG_DONATION_OPTS|length > 1 or attendee.amount_extra or attendee.gets_any_kind_of_shirt %}
        <script type="text/javascript">
            var donationChanged = function () {
                setVisible('.affiliate-row', $.val('amount_extra') > 0);
                {% if attendee.gets_any_kind_of_shirt %}
                    setVisible('.shirt-row', true);
                {% else %}
                    setVisible('.shirt-row', $.val('amount_extra') >= {{ c.SHIRT_LEVEL }});
                {% endif %}
                {% if attendee.badge_type in c.PREASSIGNED_BADGE_TYPES %}
                    setVisible('.badge-row', true);
                {% else %}
                    setVisible('.badge-row', $.val('amount_extra') >= {{ c.SUPPORTER_LEVEL }});
                {% endif %}
                $.each($("input:radio[name='amount_extra']"), function() {
                    $(this).parents('.btn').removeClass('active btn-primary');
                    $(this).parents('.btn').addClass('btn-default');
                    if ($(this).val() == $.val('amount_extra')) {
                        $(this).parents('.btn').removeClass('btn-default');
                        $(this).parents('.btn').addClass('active btn-primary');
                    }
                });
                };
            $(function(){
                if ($.field('amount_extra')) {
                    donationChanged();
                    {% if c.PAGE_PATH != '/registration/form' %}
                        if ($.field('amount_extra').is('select')) {
                            $.field('amount_extra').select2({
                                formatResult: function (opt) { return opt.text; },
                                formatSelection: function (opt) { return opt.text; },
                                minimumResultsForSearch: 99,
                                escapeMarkup: function (m) { return m; },
                                width: '100%',
                            }).select2('val', {{ attendee.amount_extra }});
                        }
                    {% endif %}
                    if ($.field('affiliate')) {
                        $.field('affiliate').select2({
                            placeholder: "I don't care about this",
                            allowClear: true,
                            tags: true,
                            data: {{ affiliates|jsonize }},
                            width: '100%',
                            createTag: function(params) {
                                var term = $.trim(params.term);

                                if (params.term === '') return null;

                                return {
                                    id: params.term,
                                    text: params.term + ' (Add new)'
                                }
                            }
                        }).val({{ attendee.affiliate|default('', boolean=True)|jsonize }}).trigger('change');
                    }
                }
            });
        </script>

        {% if c.PAGE_PATH != '/preregistration/transfer_badge' %}
            <div class="extra-row form-group">
                <label for="amount_extra" class="col-sm-3 control-label">Want to kick in extra?
                    <br>
                {{ macros.popup_link("../static_views/givingExtra.html", "Why do this?") }}
                </label>
                <div class="col-sm-9">
                    {% if c.AFTER_SUPPORTER_DEADLINE and attendee.amount_extra >= c.SUPPORTER_LEVEL or c.AFTER_SHIRT_DEADLINE and attendee.amount_extra >= c.SHIRT_LEVEL %}
                        {{ attendee.amount_extra_label }}
                        <input type="hidden" name="amount_extra" value="{{ attendee.amount_extra }}" />
                    {% else %}
                        {% if c.PREREG_DONATION_DESCRIPTIONS %}

                            <div data-toggle="buttons" class="btn-group-inline">
                            {% for tier in c.PREREG_DONATION_DESCRIPTIONS %}

                              <label class="btn btn-default btn-inline">
                                <input type="radio"
                                       name="amount_extra"
                                       autocomplete="off"
                                       value="{{ tier.price }}"
                                       onchange="donationChanged();"
                                       {% if attendee.amount_extra == tier.price %}checked{% endif %} />
                                <div class="title">
                                  <h4>{{ tier.name }}</h4>
                                  {% if tier.price %}
                                    <span>
                                      <img
                                          class="tier-icon tier-icon-{{ tier.icon|basename|replace('_', '-')|replace('.png', '') }}"
                                          src="{{ tier.icon }}"
                                          width="50px"
                                          alt="">
                                      + ${{ tier.price }}
                                    </span>
                                  {% endif %}
                                </div>
                                <ul>
                                  {% for desc, link in tier.all_descriptions %}
                                    {% if link %}
                                      <li>
                                        <a onClick="window.open('{{ link }}', 'info', 'toolbar=no,height=500,width=375,scrollbars=yes').focus(); return false;" href="{{ link }}">{{ desc }}</a>
                                      </li>
                                    {% endif %}
                                  {% endfor %}
                                </ul>
                              </label>
                            {% endfor %}
                            </div>


                        {% else %}
                            <select name="amount_extra" class="form-control" onchange="donationChanged();">
                                {{ options(c.PREREG_DONATION_OPTS, attendee.amount_extra) }}
                            </select>
                        {% endif %}
                    {% endif %}
                </div>

                <p class="help-block col-sm-offset-3 col-sm-9">
                    Each level includes all lower levels. <br/>
                    {% if c.SUPPORTER_DEADLINE != c.SHIRT_DEADLINE %}Supporter level and higher {% if c.BEFORE_SUPPORTER_DEADLINE %}are{% else %}were{% endif %} only available until {{ c.SUPPORTER_DEADLINE|datetime_local }}.<br/>{% endif %}
                    {% if c.SHIRT_DEADLINE %} {% if c.SUPPORTER_DEADLINE != c.SHIRT_DEADLINE %}Shirt level up to Supporter level{% else %}Shirt level and higher{% endif %} {% if c.BEFORE_SHIRT_DEADLINE %}are{% else %}were{% endif %} only available until {{ c.SHIRT_DEADLINE|datetime_local }}.{% endif %}
                </p>
            </div>
        {% endif %}
    {% endif %}
  {% if (not c.PREREG_DONATION_OPTS or c.PREREG_DONATION_OPTS|length <= 1) and c.PAGE_PATH in ['/preregistration/form', '/preregistration/post_form', '/preregistration/register_group_member'] %}
    <div class="extra-row form-group">
    <span class="col-sm-offset-3 col-sm-6"><strong>Kick-in tiers are no longer available</strong>. Please visit our merchandise booth on-site for t-shirts and other swag.</span>
    </div>
  {% endif %}

{%- set readonly_badge_name = c.after_printed_badge_deadline_by_type(attendee.badge_type) -%}
<div class="badge-row extra-row form-group" style="display:none">
    <label for="badge_printed_name" class="col-sm-3 control-label optional-field">Name Printed on Badge</label>
    <div class="col-sm-6">
        <input type="text" class="form-control" name="badge_printed_name" maxlength="20" value="{{ attendee.badge_printed_name }}" {% if readonly_badge_name %}readonly{% endif %} />
    </div>
    <p class="help-block col-sm-offset-3 col-sm-9">Badge names have a maximum of 20 characters.</p>
</div>

{% if readonly_badge_name %}
    <div class="badge-row extra-row form-group" style="display:none">
        <p class="help-block col-sm-6 col-sm-offset-3">(custom badges have already been ordered, so you can no longer set this)</p>
    </div>
{% endif %}

<div class="affiliate-row extra-row form-group" style="display:none">
    <label for="affiliate" class="col-sm-3 control-label optional-field">Affiliate</label>
    <div class="col-sm-6">
        <select name="affiliate">
            <option value="" selected="selected"></option>
        </select>
    </div>
    {{ macros.popup_link("../static_views/affiliates.html", "What's an affiliate?") }}
</div>

<div class="shirt-row extra-row form-group" style="display:none">
    <label for="shirt" class="col-sm-3 control-label">Shirt Size</label>
    <div class="col-sm-6">
        <select name="shirt" class="form-control">
            <option value="{{ c.NO_SHIRT }}">Select a shirt size</option>
            {{ options(c.PREREG_SHIRT_OPTS,attendee.shirt) }}
        </select>
    </div>
</div>
{% endif %}
{% if admin_area %}
  Kicked In Extra:
            <select name="amount_extra">
                {{ options(c.DONATION_TIER_OPTS,attendee.amount_extra) }}
            </select>
{% endif %}
{% endset %}


{% set extra_donation %}
{% if c.PAGE_PATH != '/preregistration/transfer_badge' and c.COLLECT_EXTRA_DONATION %}
    <div id="extra_donation">
        <div class="form-group">
            <label class="col-sm-3 control-label">Extra Donation</label>
            <div class="col-sm-6">
                <div class="input-group">
                    <span class="input-group-addon">$</span>
                        <input type="text" class="form-control" name="extra_donation" value="{% if attendee.extra_donation %}{{ attendee.extra_donation }}{% endif %}" placeholder="0">
                    <span class="input-group-addon">.00</span>
                </div>
            </div>
            {% if c.PAGE_PATH != '/registration/form' %}
                <p class="help-block col-sm-9 col-sm-offset-3">
                <strong>This donation <em>is not a kick-in</em> and does not come with merchandise.</strong><br/>
                    {{ c.ORGANIZATION_NAME }} is a 501(c)(3) charitable organization, and additional donations may be tax deductible.
                    Your employer may also have a charitable donation matching program. E-mail contact@magfest.org for details.
                </p>
            {% endif %}
        </div>
    </div>
{% endif %}
{% endset %}


{% set staffing %}
<script type="text/javascript">
  var staffingClicked = function () {
        var $staffingCheckbox = $('label[for="staffing"] input[type="checkbox"]');
        var checked = $staffingCheckbox && $staffingCheckbox.is(':visible:checked');
        setVisible('#departments', checked);
        if ($.field('no_cellphone')) {
            setVisible($.field('no_cellphone').parents('.checkbox'), checked);
        }
        {% if not attendee.is_dealer %}
            if ($.field('cellphone')) {
                $.field('cellphone').parents('.form-group').find('label:first').css('font-weight', checked ? 'bold' : 'normal');
            }
        {% endif %}
    };
  var noCellphoneClicked = function () {
        if ($.field('no_cellphone')) {
           $.field('cellphone').prop('disabled', $.field('no_cellphone').prop('checked'));
           if($.field('no_cellphone').prop('checked')) {
              $.field('cellphone').val('');
           }
        }
    };
    $(function () {
        staffingClicked();
        if ($.field('staffing')) {
            $.field('staffing').on('click', staffingClicked);
        }
        noCellphoneClicked();
        if ($.field('no_cellphone')) {
            $.field('no_cellphone').on('click', noCellphoneClicked);
        }

        {% if attendee.badge_type == c.PSEUDO_DEALER_BADGE %}
            $('#group-explanation').insertBefore($.field('first_name').parents('.form-group'));
        {% else %}
            if ($.field('badges')) {
                $('#group-explanation').insertAfter($.field('badges').parents('.form-group'));
            } else {
                $('#group-explanation').remove();
            }
        {% endif %}
    });
</script>
<div class="form-group staffing">
    <label for="staffing" class="col-sm-3 optional-field control-label">Want to Volunteer?</label>
    <div class="checkbox col-sm-6">
        {% set staffing_readonly = not admin_area and attendee.shifts %}
        <label for="staffing" {% if staffing_readonly %}title="Please {{ 'see Staffing Operations to change your volunteer status' if c.AT_THE_CON else 'unassign yourself from shifts before changing your volunteer status' }}"{% endif %}>
        {{ macros.checkbox(attendee, 'staffing', is_readonly=staffing_readonly) }}
        {% if c.PAGE_PATH == '/registration/form' %}
            This attendee is
            {% if attendee.is_new or not attendee.staffing %}
                volunteering
                </label>
            {% else %}
                </label>
                <a href='goto_volunteer_checklist?id={{ attendee.id }}'>volunteering</a>
            {% endif %}
        {% else %}
            {% if attendee.badge_type == c.STAFF_BADGE %} Yes, I want to staff {{ c.EVENT_NAME }}. {% else %} Sign me up! {% endif %}
            </label>
            <span class="popup">{{ macros.popup_link("../static_views/stafferComps.html", "What do I get for volunteering?") }}</span>
        {% endif %}
    </div>
</div>

{% if c.JOB_INTEREST_OPTS %}
<div class="form-group staffing" id="departments">
    <label for="requested_depts_ids" class="col-sm-3 control-label">Where do you want to help?</label>
    <div class="col-sm-9">
      <div class="form-control-static">
        {{ macros.checkgroup_opts(
            'requested_depts_ids',
            c.PUBLIC_DEPARTMENT_OPTS_WITH_DESC,
            defaults=attendee.requested_depts_ids,
            include_empty_hidden=True) }}
      </div>
    </div>
</div>
{% endif %}
{% endset %}


{% set age %}
<script type="text/javascript">
    var AGE_GROUPS = {{ c.AGE_GROUP_CONFIGS|jsonize }};
    var ageGroupSelected = function () {
        {% if not c.COLLECT_EXACT_BIRTHDATE %}
            setVisible('#age_disclaimer', AGE_GROUPS[$.val('age_group')].consent_form);
            if (!$.field('badge_type') || $.val('badge_type') !== {{ c.PSEUDO_DEALER_BADGE }}) {
                setVisible('.staffing', AGE_GROUPS[$.val('age_group')].can_volunteer);
                staffingClicked();
            }
        {% endif %}
    };
    $(ageGroupSelected);
</script>
<div class="form-group">
    {% if c.COLLECT_EXACT_BIRTHDATE %}
        <label for="birthdate" class="col-sm-3 control-label">Date of Birth</label>
        <div class="col-sm-6">
          <input type='text' class="form-control date" name="birthdate" value="{{ attendee.birthdate|datetime("%Y-%m-%d") }}"/>
          {% if c.PAGE_PATH == '/registration/form' and attendee.birthdate %}
              ({{ attendee.age_group_conf.desc }})
          {% endif %}
        </div>
    {% else %}
        <label for="age_group" class="col-sm-3 control-label">Age as of {{ c.EVENT_NAME }}</label>
        <div class="col-sm-6">
            <select name="age_group" class="form-control" onChange="ageGroupSelected()">
                <option value="{{ c.AGE_UNKNOWN }}">Please indicate your age</option>
                {{ options(c.PREREG_AGE_GROUP_OPTS, attendee.age_group) }}
            </select>
        </div>
    {% endif %}
    <p id="age_disclaimer" class="help-block col-sm-9 col-sm-offset-3">
      {% if c.CONSENT_FORM_URL %}
      <i>
        Attendees under 18 <b>MUST</b> bring a signed (and notarized if not accompanied by parent or guardian during badge pickup) parental
        <nobr><a target="_blank" href="{{ c.CONSENT_FORM_URL }}">consent form</a></nobr>.
      </i>
      {% endif %}
    </p>
</div>
{% endset %}


{% set email %}
<div class="form-group">
    <label for="email" class="col-sm-3 control-label">Email Address</label>
    <div class="col-sm-6">
        <input type="email" name="email" id="email" value="{{ attendee.email }}" class="form-control" placeholder="Email Address">
    </div>
</div>

{% if is_prereg_confirm_email_enabled and not admin_area %}
  <script type="text/javascript">
      $(function () {
        $('form').validate({
            rules: {
              confirm_email: { equalTo: '#email' }
            },
            messages: {
              confirm_email: {
                equalTo: 'Please make sure the email addresses match.'
              }
            },
          onkeyup: false,
          submitHandler: function(form, event) {
            // The form is already validated at this point
            $('form :submit').attr('disabled', true);
            event.target.submit();
          }
        });
      });
</script>
  <div class="form-group">
      <label for="confirm_email" class="col-sm-3 control-label">Confirm Email</label>
      <div class="col-sm-6">
          <input type="email" name="confirm_email" id="confirm_email" value="{{ attendee.email }}" class="form-control" placeholder="Confirm your email address">
      </div>
  </div>
{% endif %}
{% endset %}


{% set address %}
{% if c.COLLECT_FULL_ADDRESS %}
<script type="text/javascript">
{% include "region_opts.html" %}

        var setInternational = function () {
                countryName = $.field('country').val();
                if(countryName == 'United States') {
                    $.field('international').prop('checked', false);
                } else {
                    $.field('international').prop('checked', true);
                }
            };
        $(function () {
            $.field('international').parents('.checkbox').hide();
        });
</script>
    {% if is_prereg_dealer %}
        <div class="form-group">
            <div class="col-sm-9 col-sm-offset-3">
                {%- set attendee_address_suffix = attendee.id|replace("-", "") -%}
                {{ macros.toggle_checkbox(
                    selector='.address_details' + attendee_address_suffix,
                    label='Use my business address for my personal address.',
                    suffix=attendee_address_suffix,
                    name='copy_address',
                    checked=copy_address) }}
            </div>
        </div>
    {% endif %}

    {{ macros.address_form(attendee, update_international=True) }}

    <div class="checkbox col-sm-6 col-sm-offset-3">
        {{ macros.checkbox(attendee, 'international', label="I'm coming from outside the US.") }}
    </div>
{% else %}
  <script type="text/javascript">
  var internationalChecked = function () {
            if ($("#international").prop('checked')) {
                $("label[for='zip_code']").addClass('optional-field');
            } else if ($("#international").length) {
                $("label[for='zip_code']").removeClass('optional-field');
            }
        };
        $(function () {
            if ($('#international').length) {
                internationalChecked();
                $('#international').change(internationalChecked);
            }
        });
  </script>
    <div class="form-group">
        <label for="zip_code" class="col-sm-3 control-label {% if c.AT_OR_POST_CON %}optional-field{% endif %}">ZIP/Postal Code</label>
        <div class="col-sm-6">
            <input type="text" name="zip_code" class="form-control" value="{{ attendee.zip_code }}"{% if not c.AT_OR_POST_CON %} {% endif %}/>
        </div>
        <div class="checkbox col-sm-6 col-sm-offset-3">
            {{ macros.checkbox(attendee, 'international', label="I'm coming from outside the US.") }}
        </div>
    </div>
{% endif %}
{% endset %}


{% set emergency_contact %}
<div class="form-group">
    <label for="ec_name" class="col-sm-3 control-label">Emergency Contact</label>
    <div class="col-sm-6">
        <input type="text" name="ec_name" value="{{ attendee.ec_name }}" class="form-control" placeholder="Who we should contact if something happens to you">
    </div>
</div>
<div class="form-group">
    <label for="ec_phone" class="col-sm-3 control-label">Emergency Phone</label>
    <div class="col-sm-6">
        <input type="text" name="ec_phone" value="{{ attendee.ec_phone }}" class="form-control" placeholder="A valid phone number for your emergency contact">
    </div>
</div>
{% endset %}


{% set cellphone %}
<div class="form-group">
    <label for="cellphone" class="col-sm-3 control-label">Your Phone Number</label>
    <div class="col-sm-6">
        <input type="text" name="cellphone" id="cellphone" value="{{ attendee.cellphone }}" class="form-control" {% if attendee.is_dealer %}required{% endif %} placeholder="A phone number we can use to contact you during the event">
    </div>
    {% if not attendee.is_dealer or c.PAGE_PATH == '/registration/form' %}
        <div class="checkbox col-sm-6 col-sm-offset-3">
            {{ macros.checkbox(attendee, 'no_cellphone', label="I won't have a phone with me during the event.", label_class='cellphone-excuse') }}
        </div>
    {% endif %}
</div>
{% endset %}


{% set interests %}
{% if c.INTEREST_OPTS %}
<div class="form-group">
    <label class="col-sm-3 control-label optional-field">What interests you?</label>
    <div class="col-sm-9">
        {{ macros.checkgroup(attendee, 'interests') }}
    </div>
</div>
{% endif %}
{% endset %}


{% set found_how %}
<div class="form-group">
    <label for="found_how" class="col-sm-3 control-label optional-field">How did you find {{ c.EVENT_NAME }}?</label>
    <div class="col-sm-6">
        <input type="text" name="found_how" id="found_how" value="{{ attendee.found_how }}" class="form-control" placeholder="How did you find {{ c.EVENT_NAME }}?">
    </div>
</div>
{% endset %}

{% set comments %}
<div class="form-group">
    <label for="comments" class="col-sm-3 control-label optional-field">Comments</label>
    <div class="col-sm-6">
        <input type="textarea" name="comments" id="comments" value="{{ attendee.comments }}" class="form-control" placeholder="Comments">
    </div>
</div>
{% endset %}


{% set hotel_request %}
{% if c.HOTELS_ENABLED and c.PREREG_REQUEST_HOTEL_INFO_DURATION > 0 and (admin_area or (not is_prereg_form and not is_after_request_hotel)) %}
  {#-
    In both the admin area and non-preregistration forms, we will display a
    "Request Hotel Info" label and a checkbox.
  -#}
  <div class="form-group">
    <label for="requested_hotel_info" class="col-sm-3 control-label optional-field">Request Hotel Info</label>
    <div class="checkbox col-sm-9">
      <label for="requested_hotel_info" class="checkbox-label{% if is_after_hotel_email %} disabled" title="Can&apos;t be changed after hotel email is ready to send{% endif %}">
        {% if is_after_hotel_email %}
          {#-
            The deadline has passed; the checkbox is readonly, and
            requested_hotel_info retains whatever value the attendee
            already had.
          -#}
          <input type="hidden" name="requested_hotel_info" id="requested_hotel_info" value="{{ '1' if attendee.requested_hotel_info else '0' }}">
          <input type="checkbox" value="1" disabled {% if attendee.requested_hotel_info %}checked{% endif %}>
        {% else %}
          {#-
            The window is still open; we are very liberal with the checked
            state of the checkbox. Unless the attendee has explicitly marked
            requested_hotel_info as False, we check the box for them.
          -#}
          <input type="checkbox" name="requested_hotel_info" id="requested_hotel_info" value="1" {% if attendee.requested_hotel_info or attendee.is_placeholder or (group and group.requested_hotel_info) %}checked{% endif %}>
        {% endif %}
        Yes, tell me when hotels begin accepting reservations
      </label>
    </div>
  </div>
{% elif is_after_request_hotel %}
  {#-
    The deadline has passed; requested_hotel_info retains whatever value the
    attendee already had. This will default to False for new and placholder
    attendees.
  -#}
  <input type="hidden" name="requested_hotel_info" id="requested_hotel_info" value="{{ '1' if attendee.requested_hotel_info else '0' }}" />
{% else %}
  {#-
    The window is still open; requested_hotel_info either retains whatever
    value the attendee already had, or is set to True for new and placeholder
    attendees.
  -#}
  <input type="hidden" name="requested_hotel_info" id="requested_hotel_info" value="{{ '1' if attendee.requested_hotel_info or attendee.is_placeholder else '0' }}" />
{% endif %}
{% endset %}


{% set promo_code %}
{% if c.BADGE_PROMO_CODES_ENABLED and not group_id and (attendee.is_unpaid or attendee.promo_code_code) %}
<div class="non_group_fields form-group">
    <label for="promo_code" class="col-sm-3 control-label optional-field">Promo Code</label>
    <div class="col-sm-6">
        {% if attendee.is_unpaid %}
        <input type="textarea" name="promo_code" value="{{ attendee.promo_code_code or promo_code }}" class="form-control" placeholder="Promo Code">
        {% else %}
        <input type="hidden" name="promo_code" value="{{ attendee.promo_code_code }}">
        <p class="form-control-static">{{ attendee.promo_code_code }}</p>
        {% endif %}
    </div>
</div>
{% endif %}
{% endset %}


{% set accessibility_interest %}
{% if c.ACCESSIBILITY_SERVICES_ENABLED %}
<div class="form-group">
    <label for="email_option" class="col-sm-3 control-label optional-field">Accessibility Services</label>
    <div class="checkbox col-sm-9">
      {{ macros.checkbox(attendee, 'requested_accessibility_services', label='I would like to be contacted by the ' ~ c.EVENT_NAME ~ ' Accessibility Services department prior to the event.') }}
    </div>
</div>
{% endif %}
{% endset %}


{% set can_spam %}
<div class="form-group">
    <label for="email_option" class="col-sm-3 control-label optional-field">Keep Me Updated</label>
    <div class="checkbox col-sm-9">
        {{ macros.checkbox(attendee, 'can_spam', label='Send me emails relating to ' ~ organization_with_event_name() ~ ' in future years.') }}<br/>
        <span class="popup">{{ macros.popup_link("../static_views/privacy.html", "View Our Privacy Policy") }}</span>
    </div>
</div>
{% endset %}


{% set pii_consent %}
<div class="form-group">
  <div class="checkbox col-sm-9 col-sm-offset-3">
    <label for="pii_consent" class="checkbox-label">
    <input type="checkbox" name="pii_consent" id="pii_consent" value="1" required {% if pii_consent %}checked{% endif %} />
    <strong>Yes</strong>, you may store the personal information above in order to contact me about my registration.
    </label>
  </div>
</div>
{% endset %}

{% include "regextra.html" %}
